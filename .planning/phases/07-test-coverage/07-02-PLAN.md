---
phase: 07-test-coverage
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/unit/mcp/tools/search.test.ts
  - tests/unit/mcp/tools/index-code.test.ts
  - tests/unit/mcp/tools/status.test.ts
  - tests/unit/mcp/formatters/toon-formatter.test.ts
  - tests/unit/mcp/logger.test.ts
autonomous: true

must_haves:
  truths:
    - "All MCP tool handlers have unit tests"
    - "Input validation is tested for each tool"
    - "Error handling branches are covered"
    - "TOON formatter produces valid output"
  artifacts:
    - path: "tests/unit/mcp/tools/search.test.ts"
      provides: "Unit tests for search_code tool"
      contains: "describe.*search_code"
    - path: "tests/unit/mcp/tools/index-code.test.ts"
      provides: "Unit tests for index_code tool"
      contains: "describe.*index_code"
    - path: "tests/unit/mcp/tools/status.test.ts"
      provides: "Unit tests for get_status tool"
      contains: "describe.*get_status"
    - path: "tests/unit/mcp/formatters/toon-formatter.test.ts"
      provides: "Unit tests for TOON formatter"
      contains: "describe.*formatSearchResultsTOON"
  key_links:
    - from: "tests/unit/mcp/tools/search.test.ts"
      to: "src/rlm/mcp/tools/search.ts"
      via: "vi.mock imports"
      pattern: "vi\\.mock.*search"
---

<objective>
Create unit tests for all MCP tool handlers and TOON formatter.

Purpose: Satisfy TST-02 (unit tests for MCP tool handlers) with comprehensive coverage of input validation, success paths, and error handling.
Output: Unit test files covering search_code, index_code, get_status tools plus TOON formatter and logger.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-test-coverage/07-RESEARCH.md
@src/rlm/mcp/tools/search.ts
@src/rlm/mcp/tools/index-code.ts
@src/rlm/mcp/tools/status.ts
@src/rlm/mcp/formatters/toon-formatter.ts
@src/rlm/mcp/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unit tests for search_code and index_code tools</name>
  <files>tests/unit/mcp/tools/search.test.ts, tests/unit/mcp/tools/index-code.test.ts</files>
  <action>
Create tests/unit/mcp/tools/ directory.

Create search.test.ts testing search_code tool:
- Mock dependencies: '../../src/rlm/storage/index.js' (createQdrantClient), '../../src/rlm/retrieval/hybrid-search.js' (hybridSearch)
- Test cases:
  1. "returns TOON-formatted results for valid query" - verify response.content[0].text contains TOON
  2. "returns no-matches message when results empty" - hybridSearch returns []
  3. "returns error with troubleshooting on Qdrant failure" - hybridSearch throws
  4. "uses default limit of 5 when not specified"
  5. "respects custom limit parameter"
- Use vi.mock() at top of file for ESM hoisting
- Test the handler directly by extracting from registerSearchTool or using McpServer mock

Create index-code.test.ts testing index_code tool:
- Mock dependencies: '../../src/rlm/storage/index.js', '../../src/rlm/indexing/index.js' (indexDirectory)
- Test cases:
  1. "returns success summary with indexed count"
  2. "includes skipped count in summary"
  3. "reports first 3 errors when indexing has errors"
  4. "returns error with troubleshooting on failure"
  5. "measures elapsed time in response"
- Mock indexDirectory to return { indexed: N, skipped: M, errors: [] }
  </action>
  <verify>
npm run test -- tests/unit/mcp/tools/search.test.ts passes.
npm run test -- tests/unit/mcp/tools/index-code.test.ts passes.
  </verify>
  <done>Unit tests for search_code and index_code tools passing with input validation and error handling coverage.</done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for get_status tool and logger</name>
  <files>tests/unit/mcp/tools/status.test.ts, tests/unit/mcp/logger.test.ts</files>
  <action>
Create status.test.ts testing get_status tool:
- Mock dependencies: '../../src/rlm/storage/index.js' (createQdrantClient, getCollectionInfo)
- Test cases:
  1. "returns connected status when Qdrant available"
  2. "returns disconnected status when Qdrant unavailable" - getCollections throws
  3. "returns chunk count from collection info"
  4. "suggests starting Qdrant when disconnected"
  5. "suggests indexing when chunks count is 0"
  6. "returns error on complete failure"
- Mock client.getCollections() to test connection states

Create logger.test.ts testing stderr logger:
- Test cases:
  1. "log() writes JSON to stderr" - capture process.stderr.write
  2. "log entry includes timestamp, level, message"
  3. "log entry includes data when provided"
  4. "logInfo uses 'info' level"
  5. "logError uses 'error' level"
  6. "logWarn uses 'warn' level"
- Use vi.spyOn(process.stderr, 'write') to capture output
  </action>
  <verify>
npm run test -- tests/unit/mcp/tools/status.test.ts passes.
npm run test -- tests/unit/mcp/logger.test.ts passes.
  </verify>
  <done>Unit tests for get_status tool and logger passing with all branches covered.</done>
</task>

<task type="auto">
  <name>Task 3: Create unit tests for TOON formatter</name>
  <files>tests/unit/mcp/formatters/toon-formatter.test.ts</files>
  <action>
Create tests/unit/mcp/formatters/ directory.

Create toon-formatter.test.ts testing TOON formatting:
- Import actual @toon-format/toon decode for validation
- Test formatSearchResultsTOON():
  1. "returns valid TOON that can be decoded"
  2. "includes file, lines, relevance, code fields"
  3. "converts score to percentage (0-100)"
  4. "formats line range as 'start-end' string"
  5. "truncates code longer than 50 lines"
  6. "handles empty results array"
- Test formatSearchResultsMarkdown():
  1. "returns markdown with code blocks"
  2. "includes result numbering"
  3. "includes relevance percentage"

Use mock SearchResult objects with realistic chunk data:
```typescript
const mockResult: SearchResult = {
  id: 'chunk-1',
  score: 0.85,
  chunk: {
    id: 'chunk-1',
    text: 'function example() { return true; }',
    metadata: {
      path: 'src/example.ts',
      language: 'typescript',
      symbol_type: 'function',
      symbol_name: 'example',
      start_line: 10,
      end_line: 12,
      file_hash: 'abc123'
    }
  }
};
```
  </action>
  <verify>
npm run test -- tests/unit/mcp/formatters/toon-formatter.test.ts passes.
All tests verify TOON output can be decoded back to objects.
  </verify>
  <done>Unit tests for TOON formatter passing with validation of encoding/decoding roundtrip.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run test -- tests/unit/mcp/` passes all tests
2. Each MCP tool has tests for: valid input, error handling, edge cases
3. TOON formatter tests verify decodable output
4. Logger tests verify stderr-only output
</verification>

<success_criteria>
- search_code tests: TOON output, empty results, errors, limit parameter
- index_code tests: success summary, errors list, timing
- get_status tests: connected/disconnected, chunk count, suggestions
- logger tests: JSON format, all log levels, data inclusion
- toon-formatter tests: valid TOON, field mapping, truncation
- All tests pass with `npm run test -- tests/unit/mcp/`
</success_criteria>

<output>
After completion, create `.planning/phases/07-test-coverage/07-02-SUMMARY.md`
</output>
