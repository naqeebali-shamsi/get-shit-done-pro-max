---
phase: 07-test-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vitest.config.ts
  - package.json
  - tests/fixtures/mocks/ollama-mock.ts
  - tests/fixtures/mocks/qdrant-mock.ts
  - tests/fixtures/sample-code/example.ts
  - tests/fixtures/sample-code/example.md
  - tests/setup/test-utils.ts
autonomous: true

must_haves:
  truths:
    - "Vitest can run tests with coverage collection"
    - "Mocks produce deterministic, reproducible test results"
    - "Test fixtures provide predictable test data"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Coverage configuration with tiered thresholds"
      contains: "coverage"
    - path: "tests/fixtures/mocks/ollama-mock.ts"
      provides: "Deterministic embedding mock"
      exports: ["mockOllama", "textToVector"]
    - path: "tests/fixtures/mocks/qdrant-mock.ts"
      provides: "In-memory Qdrant mock"
      exports: ["createMockQdrantClient"]
    - path: "tests/setup/test-utils.ts"
      provides: "Shared test utilities"
      exports: ["sendJSONRPCRequest"]
  key_links:
    - from: "vitest.config.ts"
      to: "@vitest/coverage-v8"
      via: "coverage.provider"
      pattern: "provider.*v8"
---

<objective>
Set up test infrastructure: Vitest coverage configuration, deterministic mocks for Ollama/Qdrant, and test fixtures.

Purpose: Enable reproducible, isolated unit tests for MCP tools without external dependencies.
Output: vitest.config.ts with coverage, mock files, test fixtures, shared utilities.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-test-coverage/07-RESEARCH.md
@.planning/phases/07-test-coverage/07-CONTEXT.md
@.planning/phases/06-mcp-server-foundation/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install test dependencies and configure coverage</name>
  <files>package.json, vitest.config.ts</files>
  <action>
Install test dependencies:
```bash
npm install -D @vitest/coverage-v8 @testcontainers/qdrant testcontainers
```

Update vitest.config.ts with tiered coverage thresholds:
- Global minimum: 80% (lines, functions, branches, statements)
- Critical tier (90%): src/rlm/mcp/**/*.ts, src/rlm/cli/**/*.ts
- Exclude: test files, benchmarks

Configure coverage:
- provider: 'v8'
- reporter: ['text', 'json', 'html']
- include: ['src/rlm/**/*.ts']
- exclude: ['**/*.test.ts', '**/*.bench.ts', 'node_modules']

Add test script to package.json:
```json
"test": "vitest run",
"test:watch": "vitest",
"test:coverage": "vitest run --coverage"
```
  </action>
  <verify>
npm run test:coverage runs without error (may show 0% coverage initially).
vitest.config.ts contains coverage.thresholds configuration.
  </verify>
  <done>Coverage infrastructure configured with tiered thresholds. npm scripts available for test/coverage.</done>
</task>

<task type="auto">
  <name>Task 2: Create deterministic mocks for Ollama and Qdrant</name>
  <files>tests/fixtures/mocks/ollama-mock.ts, tests/fixtures/mocks/qdrant-mock.ts</files>
  <action>
Create tests/fixtures/mocks/ directory.

Create ollama-mock.ts with deterministic embedding:
- textToVector(text: string): number[] - hash-based 768-dim vector generation
- mockOllama object with embed() method that returns deterministic vectors
- Use crypto.createHash('sha256') for reproducibility
- Normalize vectors to unit length

Create qdrant-mock.ts with in-memory mock:
- createMockQdrantClient() factory function
- Internal Map<string, MockPoint[]> for collections
- Implement: getCollections, createCollection, getCollection, upsert, query, delete
- Add _reset() helper for test cleanup
- query() should return points sorted by mock score

Both mocks should be compatible with vi.mock() hoisting.
  </action>
  <verify>
Files exist at tests/fixtures/mocks/.
TypeScript compiles without errors: npx tsc --noEmit tests/fixtures/mocks/*.ts
  </verify>
  <done>Deterministic mocks created for Ollama (hash-based vectors) and Qdrant (in-memory storage).</done>
</task>

<task type="auto">
  <name>Task 3: Create test fixtures and shared utilities</name>
  <files>tests/fixtures/sample-code/example.ts, tests/fixtures/sample-code/example.md, tests/setup/test-utils.ts</files>
  <action>
Create tests/fixtures/sample-code/ directory.

Create example.ts fixture:
```typescript
// Test fixture: TypeScript example for search testing
export function calculateSum(a: number, b: number): number {
  return a + b;
}

export class Calculator {
  add(a: number, b: number): number {
    return a + b;
  }

  subtract(a: number, b: number): number {
    return a - b;
  }
}
```

Create example.md fixture:
```markdown
# Example Documentation

## Overview
This is test documentation for indexing.

## Usage
Call the function with two numbers.
```

Create tests/setup/test-utils.ts with shared utilities:
- sendJSONRPCRequest(server: ChildProcess, method: string, params: object): Promise<JSONRPCResponse>
- createTestCollection(client: MockQdrantClient, name: string): Promise<void>
- waitForServer(server: ChildProcess, timeout?: number): Promise<void>
- Type definitions for JSONRPCRequest, JSONRPCResponse

Export all utilities for use in test files.
  </action>
  <verify>
Files exist in tests/fixtures/ and tests/setup/.
npx tsc --noEmit tests/setup/test-utils.ts compiles without errors.
  </verify>
  <done>Test fixtures (sample code, markdown) and shared utilities (JSON-RPC helpers) created.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run test:coverage` runs (may show 0% or low coverage - that's expected)
2. All files in tests/fixtures/ and tests/setup/ exist
3. `npx tsc --noEmit` passes for new test files
4. vitest.config.ts has coverage.thresholds defined
</verification>

<success_criteria>
- vitest.config.ts configured with V8 coverage provider and tiered thresholds
- package.json has test, test:watch, test:coverage scripts
- Deterministic Ollama mock produces same vectors for same input
- In-memory Qdrant mock supports all required operations
- Test fixtures provide predictable test corpus
- Shared utilities simplify JSON-RPC testing
</success_criteria>

<output>
After completion, create `.planning/phases/07-test-coverage/07-01-SUMMARY.md`
</output>
