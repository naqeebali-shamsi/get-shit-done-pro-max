---
phase: 06-mcp-server-foundation
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/rlm/mcp/formatters/toon-formatter.ts
  - src/rlm/mcp/tools/search.ts
  - src/rlm/mcp/index.ts
autonomous: false

must_haves:
  truths:
    - "search_code returns TOON-formatted results"
    - "TOON format reduces token usage compared to JSON"
    - "Claude Desktop receives properly formatted search results"
  artifacts:
    - path: "src/rlm/mcp/formatters/toon-formatter.ts"
      provides: "TOON formatting for search results"
      exports: ["formatSearchResultsTOON"]
  key_links:
    - from: "src/rlm/mcp/tools/search.ts"
      to: "src/rlm/mcp/formatters/toon-formatter.ts"
      via: "import formatSearchResultsTOON"
      pattern: "import.*formatSearchResultsTOON"
---

<objective>
Add TOON (Token-Optimized Object Notation) formatting to search results for reduced token usage when communicating with Claude Desktop.

Purpose: TOON provides 30-60% token savings for uniform arrays like search results, allowing Claude to process more context within token limits.

Output:
- TOON formatter for search results
- Updated search_code tool using TOON format
- Verified end-to-end with Claude Desktop
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-mcp-server-foundation/06-RESEARCH.md
@.planning/phases/06-mcp-server-foundation/06-01-SUMMARY.md

# TOON library documentation from research
# encode() accepts object/array and returns TOON string
# Format optimized for LLM consumption
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TOON formatter for search results</name>
  <files>src/rlm/mcp/formatters/toon-formatter.ts, src/rlm/mcp/tools/search.ts, src/rlm/mcp/index.ts</files>
  <action>
Create src/rlm/mcp/formatters/toon-formatter.ts:
```typescript
/**
 * TOON Formatter for Search Results
 *
 * Token-Optimized Object Notation (TOON) provides 30-60% token savings
 * for uniform arrays like search results.
 *
 * MCP-08: TOON formatting for search results
 */

import { encode } from '@toon-format/toon';
import type { SearchResult } from '../../retrieval/hybrid-search.js';

/**
 * Structured format for TOON-encoded search results.
 */
interface TOONSearchResult {
  file: string;
  lines: string;
  relevance: number;
  code: string;
}

/**
 * Maximum lines per code chunk to prevent overly long results.
 */
const MAX_LINES_PER_RESULT = 50;

/**
 * Format search results as TOON for token-efficient LLM consumption.
 *
 * @param results - Array of search results from hybridSearch
 * @returns TOON-formatted string
 */
export function formatSearchResultsTOON(results: SearchResult[]): string {
  const formatted: TOONSearchResult[] = results.map(r => ({
    file: r.chunk.metadata.path,
    lines: `${r.chunk.metadata.start_line}-${r.chunk.metadata.end_line}`,
    relevance: Math.round(r.score * 100),
    code: truncateCode(r.chunk.text, MAX_LINES_PER_RESULT),
  }));

  // TOON encode with minimal formatting for LLM consumption
  return encode({ results: formatted }, {
    indent: 1,      // Minimal indentation
    delimiter: ',', // Comma delimiter for readability
  });
}

/**
 * Format search results as markdown (fallback for human readability).
 *
 * @param results - Array of search results from hybridSearch
 * @returns Markdown-formatted string
 */
export function formatSearchResultsMarkdown(results: SearchResult[]): string {
  return results.map((r, i) => {
    const { path, start_line, end_line } = r.chunk.metadata;
    const score = Math.round(r.score * 100);
    const code = truncateCode(r.chunk.text, MAX_LINES_PER_RESULT);
    return `## Result ${i + 1} (${score}% relevance)\nFile: ${path}\nLines: ${start_line}-${end_line}\n\n\`\`\`\n${code}\n\`\`\``;
  }).join('\n\n---\n\n');
}

/**
 * Truncate code to maximum number of lines.
 */
function truncateCode(text: string, maxLines: number): string {
  const lines = text.split('\n');
  if (lines.length <= maxLines) return text;
  return lines.slice(0, maxLines).join('\n') + `\n... (${lines.length - maxLines} more lines)`;
}
```

Update src/rlm/mcp/tools/search.ts to use TOON formatter:
- Import formatSearchResultsTOON from '../formatters/toon-formatter.js'
- Replace the inline markdown formatting with formatSearchResultsTOON(results) call
- Keep markdown format as fallback comment for reference

The key change in search.ts:
```typescript
// Replace this block:
// const formatted = results.map((r, i) => { ... }).join('\n\n---\n\n');

// With:
import { formatSearchResultsTOON } from '../formatters/toon-formatter.js';
// ... in the handler:
const formatted = formatSearchResultsTOON(results);
```

Update src/rlm/mcp/index.ts to re-export formatters:
```typescript
export { formatSearchResultsTOON, formatSearchResultsMarkdown } from './formatters/toon-formatter.js';
```

This satisfies MCP-08 (TOON formatting for search results).
  </action>
  <verify>
Run `npm run build:rlm` - builds without errors.
Run a simple test: Create a small test file that imports formatSearchResultsTOON and calls it with mock data.
Verify output is TOON format (not JSON or markdown).
  </verify>
  <done>
TOON formatter created and integrated into search_code tool. Build succeeds, formatter produces TOON output.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify MCP server end-to-end with Claude Desktop</name>
  <what-built>
Complete MCP server with three tools:
- search_code: Searches indexed codebase, returns TOON-formatted results
- index_code: Indexes a directory
- get_status: Returns system status

Server communicates via stdio JSON-RPC, logs to stderr only.
  </what-built>
  <how-to-verify>
1. Build the project:
   ```bash
   npm run build:rlm
   ```

2. Test server starts without errors:
   ```bash
   node dist/rlm/mcp/server.js
   ```
   (Server should start and wait for JSON-RPC input, logs go to stderr)
   Press Ctrl+C to stop.

3. Test tools/list response (optional, requires Qdrant running):
   ```bash
   echo '{"jsonrpc":"2.0","method":"tools/list","id":1}' | node dist/rlm/mcp/server.js
   ```
   Should return JSON with search_code, index_code, get_status tools.

4. (Optional) Configure Claude Desktop:
   Add to claude_desktop_config.json:
   ```json
   {
     "mcpServers": {
       "rlm": {
         "command": "node",
         "args": ["/path/to/dist/rlm/mcp/server.js"]
       }
     }
   }
   ```
   Verify tools appear in Claude Desktop's tool panel.

5. Verify stdout is clean (no logs on stdout):
   ```bash
   node dist/rlm/mcp/server.js 2>/dev/null
   ```
   Should show nothing until you provide JSON-RPC input.
  </how-to-verify>
  <resume-signal>Type "approved" if MCP server works correctly, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
1. TOON formatter exists: `src/rlm/mcp/formatters/toon-formatter.ts` exports formatSearchResultsTOON
2. search_code uses TOON: Imports and calls formatSearchResultsTOON
3. Build succeeds: `npm run build:rlm` completes without errors
4. Server functional: MCP server starts, responds to tools/list
5. Stdout clean: No non-JSON-RPC output on stdout
</verification>

<success_criteria>
- [ ] src/rlm/mcp/formatters/toon-formatter.ts exists with formatSearchResultsTOON export
- [ ] src/rlm/mcp/tools/search.ts imports and uses formatSearchResultsTOON
- [ ] TypeScript compiles without errors
- [ ] MCP server starts and responds to JSON-RPC
- [ ] Human verification confirms end-to-end functionality
</success_criteria>

<output>
After completion, create `.planning/phases/06-mcp-server-foundation/06-02-SUMMARY.md`
</output>
