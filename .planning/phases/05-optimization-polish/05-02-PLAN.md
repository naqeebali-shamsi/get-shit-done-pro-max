---
phase: 05-optimization-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/rlm/benchmarks/retrieval.bench.ts, vitest.config.ts]
autonomous: true
---

<objective>
Create performance benchmarking suite using Vitest bench API to measure and track RLM system performance.

Purpose: Establish baseline measurements for embedding generation, vector search, and end-to-end retrieval. Required for OPT-02 and to verify OPT-04 latency targets. Vitest bench is already installed (part of vitest ^3.0.0) and provides tinybench under the hood for sub-ms accuracy.

Output: Benchmark suite that can be run with `npx vitest bench` to measure system performance.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-optimization-polish/05-RESEARCH.md
@src/rlm/embedding/embedder.ts
@src/rlm/retrieval/hybrid-search.ts
@src/rlm/integration/quick-retrieve.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Vitest for benchmarking</name>
  <files>vitest.config.ts</files>
  <action>
Add benchmark configuration to existing vitest.config.ts:
1. Add benchmark section with:
   - include: ['**/*.bench.ts']
   - reporters: ['default', 'json']
   - outputFile: '.planning/benchmarks/results.json' (for tracking over time)
2. Create .planning/benchmarks/ directory for results

Vitest already supports bench natively - just need config. Do NOT install additional packages.
  </action>
  <verify>npx vitest bench --help shows benchmark options</verify>
  <done>vitest.config.ts includes benchmark configuration</done>
</task>

<task type="auto">
  <name>Task 2: Create retrieval benchmark suite</name>
  <files>src/rlm/benchmarks/retrieval.bench.ts</files>
  <action>
Create benchmark suite measuring:

1. Embedding generation:
   - bench('embedding generation (cold)', async () => embedText('test query', {useCache: false}))
   - bench('embedding generation (cached)', async () => embedText('test query'))

2. Vector search (requires Qdrant running):
   - bench('hybrid search (small collection)', async () => hybridSearch(...))
   - Skip gracefully if Qdrant unavailable

3. End-to-end quickRetrieve:
   - bench('quickRetrieve (5 results)', async () => quickRetrieve('test query', {limit: 5}))
   - bench('quickRetrieve (10 results)', async () => quickRetrieve('test query', {limit: 10}))

Use Vitest bench API:
- import { bench, describe } from 'vitest'
- { time: 1000 } option for 1-second benchmark duration
- { iterations: 10 } for minimum iterations

Add setup/teardown to ensure consistent state. Handle Qdrant unavailable gracefully (skip those benchmarks).
  </action>
  <verify>npx vitest bench src/rlm/benchmarks/retrieval.bench.ts runs without error (may skip Qdrant tests)</verify>
  <done>Benchmark suite measures embedding, search, and retrieval latency</done>
</task>

<task type="auto">
  <name>Task 3: Add npm script for benchmarks</name>
  <files>package.json</files>
  <action>
Add benchmark script to package.json:
- "bench": "vitest bench"
- "bench:ci": "vitest bench --reporter=json --outputFile=.planning/benchmarks/results.json"

This allows running benchmarks with `npm run bench`.
  </action>
  <verify>npm run bench executes benchmark suite</verify>
  <done>npm run bench runs benchmarks, npm run bench:ci outputs JSON</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without errors
- [ ] npx vitest bench runs without crashing
- [ ] Benchmark results show timing for embedding operations
- [ ] Benchmark results file created at .planning/benchmarks/results.json (on bench:ci)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Benchmark suite measures embedding generation latency
- Benchmark suite measures retrieval latency (when Qdrant available)
- Results can be tracked over time via JSON output
</success_criteria>

<output>
After completion, create `.planning/phases/05-optimization-polish/05-02-SUMMARY.md`
</output>
